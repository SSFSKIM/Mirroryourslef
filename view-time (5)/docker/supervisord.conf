# supervisord.conf - YouTube Analytics App 프로세스 관리

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
username=supervisor
password=supervisor_password

[supervisord]
logfile=/app/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
nodaemon=true
minfds=1024
minprocs=200
user=root

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
username=supervisor
password=supervisor_password

# 메인 FastAPI 애플리케이션
[program:fastapi]
command=/app/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
directory=/app/backend
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/fastapi.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/fastapi_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production",
    CELERY_BROKER_URL="redis://redis:6379/0",
    CELERY_RESULT_BACKEND="redis://redis:6379/0"

# Celery Beat (스케줄러)
[program:celery_beat]
command=/app/.venv/bin/celery -A backend.celery_app beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/celery_beat.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/celery_beat_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production",
    CELERY_BROKER_URL="redis://redis:6379/0",
    CELERY_RESULT_BACKEND="redis://redis:6379/0"

# Celery Flower (모니터링)
[program:celery_flower]
command=/app/.venv/bin/celery -A backend.celery_app flower --port=5555 --basic_auth=admin:flower_password
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/celery_flower.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/celery_flower_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production"

# YouTube 데이터 동기화 서비스
[program:youtube_sync]
command=/app/.venv/bin/python -m backend.services.youtube_sync_service
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=15
startretries=3
stdout_logfile=/app/logs/youtube_sync.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/youtube_sync_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production",
    LOG_LEVEL="info"

# 실시간 알림 서비스
[program:notification_service]
command=/app/.venv/bin/python -m backend.services.notification_service
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/notification.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/notification_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production"

# 메트릭 수집 서비스
[program:metrics_collector]
command=/app/.venv/bin/python -m backend.services.metrics_collector
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/metrics.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/metrics_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production"

# 로그 로테이션 서비스
[program:log_rotator]
command=/bin/bash /app/scripts/log_rotation.sh
directory=/app
user=root
autostart=true
autorestart=false
startsecs=5
startretries=1
stdout_logfile=/app/logs/log_rotator.log
stderr_logfile=/app/logs/log_rotator_error.log

# 헬스체크 서비스
[program:health_checker]
command=/app/.venv/bin/python -m backend.services.health_checker
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/app/logs/health_checker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/health_checker_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production"

# 데이터 백업 서비스 (일일 실행)
[program:data_backup]
command=/app/.venv/bin/python -m backend.services.backup_service
directory=/app
user=appuser
autostart=false
autorestart=false
startsecs=10
startretries=1
stdout_logfile=/app/logs/backup.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/app/logs/backup_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PYTHONPATH="/app/backend",
    PYTHON_ENV="production"

# 그룹 설정 - 핵심 서비스
[group:core_services]
programs=fastapi,nginx
priority=999

# 그룹 설정 - 백그라운드 작업
[group:background_services]
programs=celery_worker,celery_beat,youtube_sync,notification_service
priority=998

# 그룹 설정 - 모니터링
[group:monitoring_services]
programs=celery_flower,metrics_collector,health_checker
priority=997

# 그룹 설정 - 유지보수
[group:maintenance_services]
programs=log_rotator,data_backup
priority=996

# 이벤트 리스너 - 프로세스 상태 변경 알림
[eventlistener:crashmail]
command=/app/.venv/bin/python -m backend.utils.crash_notifier
events=PROCESS_STATE_EXITED
buffer_size=100
environment=
    PYTHONPATH="/app/backend"

# 이벤트 리스너 - 메모리 모니터링
[eventlistener:memmon]
command=/app/.venv/bin/python -m backend.utils.memory_monitor
events=TICK_60
buffer_size=100
environment=
    PYTHONPATH="/app/backend"

# 웹 인터페이스 설정 (옵션)
[inet_http_server]
port=127.0.0.1:9001
username=admin
password=supervisor_web_password

# 개발환경용 설정 (프로파일 분리)
[include]
files = /app/config/supervisor.d/*.conf
    PYTHON_ENV="production",
    LOG_LEVEL="info"

# Nginx 웹 서버
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/app/logs/nginx.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/nginx_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
user=root

# Celery Worker (백그라운드 작업)
[program:celery_worker]
command=/app/.venv/bin/celery -A backend.celery_app worker --loglevel=info --concurrency=2
directory=/app
user=appuser
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/celery_worker.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/celery_worker_error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
environment=
    PYTHONPATH="/app/backend",